{% extends "base.html" %}

{% block title %}OSRS Bot Manager - Running Bot{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                <i class="fas fa-robot text-success"></i> 
                {% if current_bot %}
                    {{ bots[current_bot.bot_id].name if current_bot.bot_id in bots else current_bot.bot_id }}
                    <span class="badge bg-{{ 'success' if current_bot.status.status == 'running' else 'warning' if current_bot.status.status == 'paused' else 'danger' }} ms-2">
                        {{ current_bot.status.status.replace('_', ' ').title() }}
                    </span>
                {% else %}
                    No Bot Running
                {% endif %}
            </h1>
            <div class="btn-group" role="group">
                {% if current_bot %}
                    {% if current_bot.status.status == 'running' %}
                        <button class="btn btn-warning" onclick="controlBot('{{ current_bot.bot_id }}', 'pause')">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                    {% elif current_bot.status.status == 'paused' %}
                        <button class="btn btn-success" onclick="controlBot('{{ current_bot.bot_id }}', 'resume')">
                            <i class="fas fa-play"></i> Resume
                        </button>
                    {% endif %}
                    <button class="btn btn-danger" onclick="stopBot('{{ current_bot.bot_id }}')">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <a class="btn btn-info" href="{{ url_for('bot_detail', bot_id=current_bot.bot_id) }}">
                        <i class="fas fa-cog"></i> Configure
                    </a>
                {% else %}
                    <a class="btn btn-primary" href="{{ url_for('index') }}">
                        <i class="fas fa-plus"></i> Start a Bot
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if current_bot %}
<!-- Bot Status Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="text-muted mb-2">Runtime</h6>
                        <h4 id="runtime-display">{{ "%.1f"|format(current_bot.status.runtime or 0) }}s</h4>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted mb-2">Bot Type</h6>
                        <h5>{{ bots[current_bot.bot_id].name if current_bot.bot_id in bots else current_bot.bot_id }}</h5>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted mb-2">Status</h6>
                        <h5>
                            <span class="badge bg-{{ 'success' if current_bot.status.status == 'running' else 'warning' if current_bot.status.status == 'paused' else 'danger' }}">
                                {{ current_bot.status.status.replace('_', ' ').title() }}
                            </span>
                        </h5>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted mb-2">API Port</h6>
                        <h5>{{ current_bot.api_port }}</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Professional Browser-Style Tabs -->
<div class="row">
    <div class="col-12">
        <div class="browser-tabs-container">
            <!-- Tab Headers -->
            <div class="browser-tabs-header">
                <div class="browser-tab active" data-target="logs-pane" id="logs-tab">
                    <div class="tab-content-wrapper">
                        <i class="fas fa-file-alt"></i>
                        <span class="tab-title">Bot Logs</span>
                    </div>
                    <div class="tab-close" style="display: none;">×</div>
                </div>
                <div class="browser-tab" data-target="cv-debug-pane" id="cv-debug-tab">
                    <div class="tab-content-wrapper">
                        <i class="fas fa-eye"></i>
                        <span class="tab-title">CV Debug</span>
                    </div>
                    <div class="tab-close" style="display: none;">×</div>
                </div>
            </div>
            
            <!-- Tab Content -->
            <div class="browser-tabs-content">
                <!-- Logs Tab -->
                <div class="tab-pane active" id="logs-pane">
                    <div id="log-viewer-container" style="height: 600px;">
                        <!-- Log viewer will be embedded here -->
                    </div>
                </div>
                
                <!-- CV Debug Tab -->
                <div class="tab-pane" id="cv-debug-pane">
                    <div class="cv-debug-container" style="height: 600px;">
                        <iframe id="cv-debug-frame" 
                                src="http://localhost:{{ current_bot.api_port }}/debug" 
                                style="width: 100%; height: 100%; border: none; background: #111;"
                                title="CV Debug View">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Bot Running -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-robot fa-4x text-muted mb-4"></i>
                <h3 class="text-muted">No Bot Currently Running</h3>
                <p class="text-muted mb-4">Start a bot to view its logs and CV debug information</p>
                <a class="btn btn-primary btn-lg" href="{{ url_for('index') }}">
                    <i class="fas fa-plus"></i> Start a Bot
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
{% if current_bot %}
// Auto-refresh runtime counter
let startTime = {{ current_bot.status.runtime or 0 }};
let runtimeCounter = setInterval(() => {
    startTime += 1;
    document.getElementById('runtime-display').textContent = startTime.toFixed(1) + 's';
}, 1000);

// Bot control functions
function controlBot(botId, action) {
    fetch(`/api/bot/${botId}/control`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI dynamically instead of reloading
            updateBotStatus(botId, action);
        } else {
            alert(`Failed to ${action} bot`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`Error controlling bot: ${error.message}`);
    });
}

function stopBot(botId) {
    if (!confirm('Are you sure you want to stop this bot?')) {
        return;
    }
    
    fetch(`/api/bot/${botId}/stop`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/';
        } else {
            alert('Failed to stop bot');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`Error stopping bot: ${error.message}`);
    });
}

function updateBotStatus(botId, action) {
    // Immediately update UI for responsiveness, monitoring will sync the actual state
    const statusBadge = document.querySelector('.badge');
    const statusBadgeInCard = document.querySelector('.card-body .badge');
    const pauseBtn = document.querySelector('.btn-warning');
    const resumeBtn = document.querySelector('.btn-success');
    
    if (action === 'pause') {
        // Update all status indicators
        if (statusBadge) {
            statusBadge.className = 'badge bg-warning ms-2';
            statusBadge.textContent = 'Paused';
        }
        if (statusBadgeInCard) {
            statusBadgeInCard.className = 'badge bg-warning';
            statusBadgeInCard.textContent = 'Paused';
        }
        
        // Update button state
        if (pauseBtn) {
            pauseBtn.className = 'btn btn-success';
            pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
            pauseBtn.setAttribute('onclick', `controlBot('${botId}', 'resume')`);
        }
        
    } else if (action === 'resume') {
        // Update all status indicators
        if (statusBadge) {
            statusBadge.className = 'badge bg-success ms-2';
            statusBadge.textContent = 'Running';
        }
        if (statusBadgeInCard) {
            statusBadgeInCard.className = 'badge bg-success';
            statusBadgeInCard.textContent = 'Running';
        }
        
        // Update button state
        if (resumeBtn) {
            resumeBtn.className = 'btn btn-warning';
            resumeBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
            resumeBtn.setAttribute('onclick', `controlBot('${botId}', 'pause')`);
        }
    }
    
    // Force a status check after a short delay to ensure synchronization
    setTimeout(async () => {
        try {
            const response = await fetch(`/api/bot/${botId}/status`);
            const data = await response.json();
            
            // Verify the state matches what we expect
            if ((action === 'pause' && data.status !== 'paused') || 
                (action === 'resume' && data.status !== 'running')) {
                console.warn(`Status mismatch: expected ${action === 'pause' ? 'paused' : 'running'}, got ${data.status}`);
                // The monitoring system will correct this on the next cycle
            }
        } catch (error) {
            console.error('Error verifying status after control action:', error);
        }
    }, 500);
}

// Initialize browser-style tabs and load viewers
document.addEventListener('DOMContentLoaded', function() {
    initializeBrowserTabs();
    
    // Load log viewer immediately since it's the active tab
    loadLogViewer();
});

function initializeBrowserTabs() {
    const tabs = document.querySelectorAll('.browser-tab');
    const panes = document.querySelectorAll('.tab-pane');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            
            // Remove active class from all tabs and panes
            tabs.forEach(t => t.classList.remove('active'));
            panes.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding pane
            this.classList.add('active');
            const targetPane = document.getElementById(targetId);
            if (targetPane) {
                targetPane.classList.add('active');
                
                // Handle specific tab content loading
                if (targetId === 'logs-pane') {
                    loadLogViewer();
                } else if (targetId === 'cv-debug-pane') {
                    // Refresh CV debug iframe
                    const iframe = document.getElementById('cv-debug-frame');
                    if (iframe) {
                        // Force refresh to ensure CV debug is loaded properly
                        iframe.src = iframe.src.split('?')[0] + '?t=' + Date.now();
                    }
                }
            }
        });
    });
}

function loadLogViewer() {
    const container = document.getElementById('log-viewer-container');
    if (container && !container.querySelector('.log-viewer-content')) {
        // Create the log viewer content
        container.innerHTML = `
            <div class="log-viewer-content" style="height: 100%; display: flex; flex-direction: column;">
                <div class="log-viewer-header" style="padding: 10px; border-bottom: 1px solid var(--border-color); background: var(--card-bg);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-file-alt"></i> Bot Logs
                                <span class="connection-indicator ms-2" id="logConnectionIndicator" title="WebSocket Connection Status"></span>
                            </h6>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" id="clearLogsBtn">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="toggleFiltersBtn">
                                <i class="fas fa-filter"></i> Filters
                            </button>
                        </div>
                    </div>
                </div>
                <div class="log-viewer-body" style="flex: 1; display: flex; overflow: hidden;">
                    <div class="log-filters" id="logFilters" style="width: 250px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); padding: 10px; overflow-y: auto; display: none;">
                        <div class="filter-group mb-3">
                            <h6>Log Levels</h6>
                            <div class="form-check">
                                <input class="form-check-input level-filter" type="checkbox" value="DEBUG" id="levelDEBUG" checked>
                                <label class="form-check-label" for="levelDEBUG">DEBUG</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input level-filter" type="checkbox" value="INFO" id="levelINFO" checked>
                                <label class="form-check-label" for="levelINFO">INFO</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input level-filter" type="checkbox" value="WARNING" id="levelWARNING" checked>
                                <label class="form-check-label" for="levelWARNING">WARNING</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input level-filter" type="checkbox" value="ERROR" id="levelERROR" checked>
                                <label class="form-check-label" for="levelERROR">ERROR</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input level-filter" type="checkbox" value="CRITICAL" id="levelCRITICAL" checked>
                                <label class="form-check-label" for="levelCRITICAL">CRITICAL</label>
                            </div>
                        </div>
                        <div class="filter-group">
                            <h6>Loggers</h6>
                            <div id="loggerFilters">
                                <!-- Logger checkboxes will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="log-content" style="flex: 1; padding: 10px; background: var(--code-bg); font-family: 'Courier New', monospace; font-size: 0.85rem; overflow-y: auto; color: var(--text-color);" id="logContent">
                        <div class="text-muted">Connecting to log server...</div>
                    </div>
                </div>
            </div>
        `;
        
        // Initialize log viewer functionality
        initializeLogViewer();
    }
}

function initializeLogViewer() {
    let socket = null;
    let allowedLevels = new Set(['DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL']);
    let subscribedLoggers = new Set();
    let availableLoggers = [];
    
    const connectionIndicator = document.getElementById('logConnectionIndicator');
    const logContent = document.getElementById('logContent');
    const clearLogsBtn = document.getElementById('clearLogsBtn');
    const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
    const logFilters = document.getElementById('logFilters');
    
    async function connectWebSocket() {
        if (socket) {
            try {
                socket.close();
            } catch (e) {
                console.log('Error closing existing socket:', e);
            }
        }
        
        try {
            // Get the actual logging port from the server
            const response = await fetch('/api/logging/port');
            const data = await response.json();
            const port = data.port;
            
            if (!port) {
                console.log('WebSocket server port not available yet, retrying...');
                connectionIndicator.className = 'connection-indicator ms-2 bg-warning';
                connectionIndicator.title = 'WebSocket server starting...';
                // Retry after 1 second for faster startup
                setTimeout(connectWebSocket, 1000);
                return;
            }
            
            const wsUrl = `ws://localhost:${port}`;
            console.log(`Connecting to WebSocket on port ${port}`);
            socket = new WebSocket(wsUrl);
            
            setupWebSocketHandlers(port);
            
        } catch (error) {
            console.error('Failed to get logging port:', error);
            connectionIndicator.className = 'connection-indicator ms-2 bg-danger';
            connectionIndicator.title = 'Failed to connect to log server';
            // Retry after 5 seconds
            setTimeout(connectWebSocket, 5000);
        }
    }
    
    function setupWebSocketHandlers(port) {
        
        socket.addEventListener('open', () => {
            console.log(`Log WebSocket connected to port ${port}`);
            connectionIndicator.className = 'connection-indicator ms-2 bg-success';
            connectionIndicator.style.cssText = 'width: 8px; height: 8px; border-radius: 50%; display: inline-block;';
            connectionIndicator.title = `Connected to log server on port ${port}`;
            
            // Request loggers and subscribe
            socket.send(JSON.stringify({command: 'get_loggers'}));
        });
        
        socket.addEventListener('message', event => {
            try {
                const msg = JSON.parse(event.data);
                handleLogMessage(msg);
            } catch (err) {
                console.error('Invalid JSON from log server:', event.data);
            }
        });
        
        socket.addEventListener('close', () => {
            console.warn(`Log WebSocket closed on port ${port}`);
            connectionIndicator.className = 'connection-indicator ms-2 bg-danger';
            connectionIndicator.style.cssText = 'width: 8px; height: 8px; border-radius: 50%; display: inline-block;';
            connectionIndicator.title = 'Disconnected from log server';
            
            // Attempt to reconnect after 3 seconds
            setTimeout(connectWebSocket, 3000);
        });
        
        socket.addEventListener('error', (error) => {
            console.error(`Log WebSocket error on port ${port}:`, error);
            connectionIndicator.className = 'connection-indicator ms-2 bg-warning';
            connectionIndicator.title = 'Log server connection error';
            
            // Retry connection after 5 seconds
            setTimeout(connectWebSocket, 5000);
        });
    }
    
    function handleLogMessage(msg) {
        switch (msg.type) {
            case 'loggers_list':
                availableLoggers = msg.loggers;
                populateLoggerFilters(msg.loggers);
                // Subscribe to all loggers initially
                subscribedLoggers = new Set(msg.loggers);
                socket.send(JSON.stringify({command: 'subscribe', loggers: msg.loggers}));
                break;
                
            case 'log':
                if (allowedLevels.has(msg.level) && subscribedLoggers.has(msg.logger_name)) {
                    renderLogEntry(msg);
                }
                break;
                
            case 'notification':
                handleBotNotification(msg);
                break;
        }
    }
    
    function populateLoggerFilters(loggers) {
        const loggerFilters = document.getElementById('loggerFilters');
        loggerFilters.innerHTML = '';
        
        loggers.sort().forEach(logger => {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
                <input class="form-check-input logger-filter" type="checkbox" value="${logger}" id="logger${logger}" checked>
                <label class="form-check-label" for="logger${logger}">${logger}</label>
            `;
            loggerFilters.appendChild(div);
        });
        
        // Add event listeners for logger filters
        document.querySelectorAll('.logger-filter').forEach(cb => {
            cb.addEventListener('change', (e) => {
                if (e.target.checked) {
                    subscribedLoggers.add(e.target.value);
                } else {
                    subscribedLoggers.delete(e.target.value);
                }
                socket.send(JSON.stringify({command: 'subscribe', loggers: Array.from(subscribedLoggers)}));
            });
        });
    }
    
    function renderLogEntry({timestamp, logger_name, level, message}) {
        const entry = document.createElement('div');
        entry.style.marginBottom = '2px';
        entry.style.padding = '2px 0';
        
        const levelColors = {
            'DEBUG': '#9cdcfe',
            'INFO': '#dcdcaa', 
            'WARNING': '#d7ba7d',
            'ERROR': '#f44747',
            'CRITICAL': '#f44747'
        };
        
        entry.innerHTML = `
            <span style="color: #888; margin-right: 8px;">[${timestamp}]</span>
            <span style="color: #c586c0; margin-right: 8px;">${logger_name}</span>
            <span style="color: ${levelColors[level]}; margin-right: 8px;">${level}</span>
            <span style="color: var(--text-color);">${message}</span>
        `;
        
        logContent.appendChild(entry);
        logContent.scrollTop = logContent.scrollHeight;
        
        // Keep only last 1000 entries
        while (logContent.children.length > 1000) {
            logContent.removeChild(logContent.firstChild);
        }
    }
    
    function handleBotNotification(msg) {
        // Handle bot termination and other notifications
        if (msg.message && msg.message.includes('has terminated')) {
            // Bot has terminated - update the UI
            const statusBadge = document.querySelector('.badge');
            if (statusBadge) {
                statusBadge.textContent = 'Terminated';
                statusBadge.className = 'badge bg-secondary';
            }
            
            // Disable control buttons
            const pauseBtn = document.querySelector('.btn-warning');
            const resumeBtn = document.querySelector('.btn-success');
            const stopBtn = document.querySelector('.btn-danger');
            
            if (pauseBtn) pauseBtn.disabled = true;
            if (resumeBtn) resumeBtn.disabled = true;
            if (stopBtn) stopBtn.disabled = true;
            
            // Show an alert/toast about the termination
            showNotificationToast(msg.message, msg.level || 'warning');
            
            // Optional: Auto-redirect after a few seconds
            setTimeout(() => {
                window.location.href = '/';
            }, 5000);
        } else {
            // Other notifications - just show as toast
            showNotificationToast(msg.message, msg.level || 'info');
        }
    }
    
    function showNotificationToast(message, level = 'info') {
        // Create a simple toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${level === 'warning' ? 'warning' : level === 'error' ? 'danger' : 'info'} alert-dismissible`;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            opacity: 0;
            transition: opacity 0.3s;
        `;
        
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" aria-label="Close"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Fade in
        setTimeout(() => toast.style.opacity = '1', 10);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 5000);
        
        // Manual dismiss
        toast.querySelector('.btn-close').addEventListener('click', () => {
            toast.style.opacity = '0';
            setTimeout(() => document.body.removeChild(toast), 300);
        });
    }
    
    // Event listeners
    clearLogsBtn.addEventListener('click', () => {
        logContent.innerHTML = '';
    });
    
    toggleFiltersBtn.addEventListener('click', () => {
        logFilters.style.display = logFilters.style.display === 'none' ? 'block' : 'none';
    });
    
    // Level filter event listeners
    document.querySelectorAll('.level-filter').forEach(cb => {
        cb.addEventListener('change', (e) => {
            if (e.target.checked) {
                allowedLevels.add(e.target.value);
            } else {
                allowedLevels.delete(e.target.value);
            }
        });
    });
    
    // Start periodic status monitoring
    function startStatusMonitoring() {
        const statusInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/bot/{{ current_bot.bot_id }}/status`);
                const data = await response.json();
                
                // Get current UI elements
                const statusBadge = document.querySelector('.badge');
                const statusBadgeInCard = document.querySelector('.card-body .badge');
                const pauseBtn = document.querySelector('.btn-warning');
                const resumeBtn = document.querySelector('.btn-success');
                const stopBtn = document.querySelector('.btn-danger');
                const runtimeDisplay = document.getElementById('runtime-display');
                
                if (data.status === 'terminated' || data.status === 'not_running') {
                    // Bot has terminated
                    clearInterval(statusInterval);
                    
                    if (statusBadge && statusBadge.textContent !== 'Terminated') {
                        statusBadge.textContent = 'Terminated';
                        statusBadge.className = 'badge bg-secondary ms-2';
                    }
                    if (statusBadgeInCard) {
                        statusBadgeInCard.textContent = 'Terminated';
                        statusBadgeInCard.className = 'badge bg-secondary';
                    }
                    
                    // Disable control buttons
                    if (pauseBtn) pauseBtn.disabled = true;
                    if (resumeBtn) resumeBtn.disabled = true;
                    if (stopBtn) stopBtn.disabled = true;
                    
                    showNotificationToast('Bot has terminated', 'warning');
                    
                    // Auto-redirect after a few seconds
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 5000);
                    
                } else if (data.status === 'paused') {
                    // Bot is paused - synchronize UI
                    if (statusBadge) {
                        statusBadge.textContent = 'Paused';
                        statusBadge.className = 'badge bg-warning ms-2';
                    }
                    if (statusBadgeInCard) {
                        statusBadgeInCard.textContent = 'Paused';
                        statusBadgeInCard.className = 'badge bg-warning';
                    }
                    
                    // Update buttons to show correct state
                    if (pauseBtn && pauseBtn.innerHTML.includes('Pause')) {
                        // Currently showing pause button, switch to resume
                        pauseBtn.className = 'btn btn-success';
                        pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
                        pauseBtn.setAttribute('onclick', `controlBot('{{ current_bot.bot_id }}', 'resume')`);
                    }
                    
                } else if (data.status === 'running') {
                    // Bot is running - synchronize UI
                    if (statusBadge) {
                        statusBadge.textContent = 'Running';
                        statusBadge.className = 'badge bg-success ms-2';
                    }
                    if (statusBadgeInCard) {
                        statusBadgeInCard.textContent = 'Running';
                        statusBadgeInCard.className = 'badge bg-success';
                    }
                    
                    // Update buttons to show correct state
                    if (resumeBtn && resumeBtn.innerHTML.includes('Resume')) {
                        // Currently showing resume button, switch to pause
                        resumeBtn.className = 'btn btn-warning';
                        resumeBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                        resumeBtn.setAttribute('onclick', `controlBot('{{ current_bot.bot_id }}', 'pause')`);
                    }
                }
                
                // Update runtime if available
                if (runtimeDisplay && data.runtime !== undefined) {
                    runtimeDisplay.textContent = `${data.runtime.toFixed(1)}s`;
                }
                
            } catch (error) {
                console.error('Error checking bot status:', error);
            }
        }, 2000); // Check every 2 seconds for better responsiveness
    }
    
    // Connect to WebSocket
    connectWebSocket();
    
    // Start status monitoring
    startStatusMonitoring();
}
{% endif %}
</script>
{% endblock %}