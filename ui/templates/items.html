{% extends "base.html" %}

{% block title %}Item Database - OSRS Bot Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-database"></i> Item Database
                    </h4>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" onclick="toggleFilters()">
                            <i class="fas fa-filter"></i> Filters
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="clearSearch()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Search Bar -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="searchInput" 
                                       placeholder="Search for items... (e.g., 'rune', 'sword', 'potion')"
                                       autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select form-select-lg" id="limitSelect">
                                <option value="25">Show 25 results</option>
                                <option value="50" selected>Show 50 results</option>
                                <option value="100">Show 100 results</option>
                                <option value="200">Show 200 results</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filters Panel -->
                    <div class="row mb-3" id="filtersPanel" style="display: none;">
                        <div class="col-12">
                            <div class="card bg-dark border-secondary">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-filter"></i> Advanced Filters
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="filterTradeable">
                                                <label class="form-check-label" for="filterTradeable">
                                                    <i class="fas fa-coins"></i> Tradeable on GE
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="filterMembers">
                                                <label class="form-check-label" for="filterMembers">
                                                    <i class="fas fa-crown"></i> Members Only
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="filterStackable">
                                                <label class="form-check-label" for="filterStackable">
                                                    <i class="fas fa-layer-group"></i> Stackable
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="filterEquipable">
                                                <label class="form-check-label" for="filterEquipable">
                                                    <i class="fas fa-shield-alt"></i> Equipable
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Status -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div id="searchStatus" class="text-muted small">
                                Enter a search term to find items in the database
                            </div>
                        </div>
                    </div>

                    <!-- Results Grid -->
                    <div id="resultsContainer">
                        <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Searching items...</div>
                        </div>

                        <div id="noResults" class="text-center py-5 text-muted" style="display: none;">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <h5>No items found</h5>
                            <p>Try adjusting your search terms or filters</p>
                        </div>

                        <div id="searchResults" class="row"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Item Detail Modal -->
<div class="modal fade" id="itemDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle"></i> Item Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="itemDetailContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyItemInfo()">
                    <i class="fas fa-copy"></i> Copy Item Info
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.item-card {
    transition: all 0.2s ease-in-out;
    cursor: pointer;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
}

.item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.4);
    border-color: var(--primary-color);
}

.item-icon {
    width: 32px;
    height: 32px;
    object-fit: contain;
    background: #1a1a1a;
    border-radius: 4px;
    padding: 2px;
}

.item-attributes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
}

.item-attribute {
    font-size: 0.7rem;
    padding: 0.1rem 0.4rem;
    border-radius: 0.25rem;
    background: rgba(255, 255, 255, 0.1);
}

.attribute-tradeable { background: rgba(40, 167, 69, 0.2) !important; color: #28a745; }
.attribute-members { background: rgba(255, 193, 7, 0.2) !important; color: #ffc107; }
.attribute-stackable { background: rgba(23, 162, 184, 0.2) !important; color: #17a2b8; }
.attribute-equipable { background: rgba(108, 117, 125, 0.2) !important; color: #6c757d; }
.attribute-noted { background: rgba(255, 107, 107, 0.2) !important; color: #ff6b6b; }

.item-stats {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.stat-positive {
    color: var(--success-color);
}

.search-highlight {
    background: rgba(77, 171, 247, 0.3);
    padding: 0.1rem 0.2rem;
    border-radius: 0.2rem;
}
</style>

<script>
let searchTimeout = null;
let currentModal = null;

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const limitSelect = document.getElementById('limitSelect');
    
    // Search input handler with debouncing
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            performSearch();
        }, 300);
    });
    
    // Limit change handler
    limitSelect.addEventListener('change', performSearch);
    
    // Filter change handlers
    document.querySelectorAll('#filtersPanel input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', performSearch);
    });
    
    // Enter key handler
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            performSearch();
        }
    });
    
    // Focus search input
    searchInput.focus();
});

function toggleFilters() {
    const panel = document.getElementById('filtersPanel');
    if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
    } else {
        panel.style.display = 'none';
    }
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('limitSelect').value = '50';
    document.querySelectorAll('#filtersPanel input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('searchStatus').textContent = 'Enter a search term to find items in the database';
}

function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    const limit = document.getElementById('limitSelect').value;
    
    if (!query) {
        document.getElementById('searchResults').innerHTML = '';
        document.getElementById('searchStatus').textContent = 'Enter a search term to find items in the database';
        return;
    }
    
    // Show loading
    showLoading(true);
    
    // Build query parameters
    const params = new URLSearchParams({
        q: query,
        limit: limit
    });
    
    // Add filters
    if (document.getElementById('filterTradeable').checked) params.append('tradeable', 'true');
    if (document.getElementById('filterMembers').checked) params.append('members', 'true');
    if (document.getElementById('filterStackable').checked) params.append('stackable', 'true');
    if (document.getElementById('filterEquipable').checked) params.append('equipable', 'true');
    
    fetch(`/api/items/search?${params}`)
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.success) {
                displayResults(data.results, query);
                updateSearchStatus(data.count, query);
            } else {
                showError(`Search failed: ${data.error}`);
            }
        })
        .catch(error => {
            showLoading(false);
            showError(`Network error: ${error.message}`);
        });
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    document.getElementById('noResults').style.display = 'none';
    if (show) {
        document.getElementById('searchResults').innerHTML = '';
    }
}

function updateSearchStatus(count, query) {
    const status = document.getElementById('searchStatus');
    if (count === 0) {
        status.innerHTML = `No items found for "<strong>${escapeHtml(query)}</strong>"`;
    } else {
        status.innerHTML = `Found <strong>${count}</strong> item${count !== 1 ? 's' : ''} for "<strong>${escapeHtml(query)}</strong>"`;
    }
}

function displayResults(items, query) {
    const container = document.getElementById('searchResults');
    
    if (items.length === 0) {
        document.getElementById('noResults').style.display = 'block';
        return;
    }
    
    const queryLower = query.toLowerCase();
    
    container.innerHTML = items.map(item => `
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-3">
            <div class="card item-card h-100" onclick="showItemDetail(${item.id})">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-2">
                        <div class="me-3">
                            ${item.icon_b64 ? 
                                `<img src="data:image/png;base64,${item.icon_b64}" class="item-icon" alt="${escapeHtml(item.name)} icon">` :
                                `<div class="item-icon d-flex align-items-center justify-content-center bg-secondary">
                                    <i class="fas fa-question text-muted"></i>
                                </div>`
                            }
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1" style="font-size: 0.9rem;">
                                ${highlightText(escapeHtml(item.name), query)}
                            </h6>
                            <div class="text-muted small mb-2">ID: ${item.id}</div>
                        </div>
                    </div>
                    
                    <div class="item-attributes mb-2">
                        ${item.tradeable_on_ge ? '<span class="item-attribute attribute-tradeable">GE</span>' : ''}
                        ${item.members ? '<span class="item-attribute attribute-members">Members</span>' : ''}
                        ${item.stackable ? '<span class="item-attribute attribute-stackable">Stackable</span>' : ''}
                        ${item.equipable ? '<span class="item-attribute attribute-equipable">Equipable</span>' : ''}
                        ${item.noted ? '<span class="item-attribute attribute-noted">Noted</span>' : ''}
                    </div>
                    
                    <div class="item-stats">
                        ${item.cost > 0 ? `<div>Shop: <span class="stat-positive">${formatNumber(item.cost)} gp</span></div>` : ''}
                        ${item.highalch > 0 ? `<div>High Alch: <span class="stat-positive">${formatNumber(item.highalch)} gp</span></div>` : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function showItemDetail(itemId) {
    fetch(`/api/items/${itemId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayItemDetail(data.item);
            } else {
                showError(`Failed to load item details: ${data.error}`);
            }
        })
        .catch(error => {
            showError(`Network error: ${error.message}`);
        });
}

function displayItemDetail(item) {
    const content = document.getElementById('itemDetailContent');
    currentModal = item;
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-4 text-center">
                ${item.icon_b64 ? 
                    `<img src="data:image/png;base64,${item.icon_b64}" class="img-fluid mb-3" style="max-width: 128px; background: #1a1a1a; border-radius: 8px; padding: 8px;" alt="${escapeHtml(item.name)} icon">` :
                    `<div class="bg-secondary rounded d-flex align-items-center justify-content-center mb-3" style="width: 128px; height: 128px; margin: 0 auto;">
                        <i class="fas fa-question fa-3x text-muted"></i>
                    </div>`
                }
                <h5>${escapeHtml(item.name)}</h5>
                <p class="text-muted">ID: ${item.id}</p>
            </div>
            <div class="col-md-8">
                <h6>Properties</h6>
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="mb-2">
                            <i class="fas fa-${item.tradeable_on_ge ? 'check text-success' : 'times text-danger'}"></i>
                            Tradeable on GE
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-${item.members ? 'crown text-warning' : 'times text-muted'}"></i>
                            Members ${item.members ? 'Only' : 'Item'}
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-${item.stackable ? 'layer-group text-info' : 'times text-muted'}"></i>
                            Stackable
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="mb-2">
                            <i class="fas fa-${item.equipable ? 'shield-alt text-secondary' : 'times text-muted'}"></i>
                            Equipable
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-${item.noted ? 'file-alt text-danger' : 'times text-muted'}"></i>
                            Noted
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-${item.noteable ? 'check text-success' : 'times text-muted'}"></i>
                            Noteable
                        </div>
                    </div>
                </div>
                
                <h6>Values</h6>
                <div class="row">
                    <div class="col-12">
                        ${item.cost > 0 ? `<div class="mb-2">Shop Price: <strong>${formatNumber(item.cost)} gp</strong></div>` : ''}
                        ${item.lowalch > 0 ? `<div class="mb-2">Low Alch: <strong>${formatNumber(item.lowalch)} gp</strong></div>` : ''}
                        ${item.highalch > 0 ? `<div class="mb-2">High Alch: <strong>${formatNumber(item.highalch)} gp</strong></div>` : ''}
                        ${item.cost === 0 && item.lowalch === 0 && item.highalch === 0 ? '<div class="text-muted">No pricing information available</div>' : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('itemDetailModal'));
    modal.show();
}

function copyItemInfo() {
    if (!currentModal) return;
    
    const info = `Item: ${currentModal.name}
ID: ${currentModal.id}
Tradeable on GE: ${currentModal.tradeable_on_ge ? 'Yes' : 'No'}
Members: ${currentModal.members ? 'Yes' : 'No'}
Stackable: ${currentModal.stackable ? 'Yes' : 'No'}
Equipable: ${currentModal.equipable ? 'Yes' : 'No'}${currentModal.cost > 0 ? `
Shop Price: ${formatNumber(currentModal.cost)} gp` : ''}${currentModal.highalch > 0 ? `
High Alch: ${formatNumber(currentModal.highalch)} gp` : ''}`;
    
    navigator.clipboard.writeText(info).then(() => {
        showToast('Item information copied to clipboard!');
    }).catch(() => {
        showToast('Failed to copy to clipboard', 'error');
    });
}

function highlightText(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeRegex(text) {
    return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function formatNumber(num) {
    return num.toLocaleString();
}

function showError(message) {
    document.getElementById('searchStatus').innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${escapeHtml(message)}</span>`;
}

function showToast(message, type = 'success') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}
</script>
{% endblock %}